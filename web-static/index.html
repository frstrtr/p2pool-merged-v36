<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
        <title>P2Pool</title>
        <link rel="shortcut icon" type="image/x-icon" href="favicon.ico" />
        <script type="text/javascript" src="d3.v2.min.js"></script>
        <script type="text/javascript">
            // based on goblin's p2pool-stats project
            
            function format_dt(dt) {
                var pairs = [
                    [365.2425*60*60*24, 'years'],
                    [60*60*24, 'days'],
                    [60*60, 'hours'],
                    [60, 'minutes'],
                    [1, 'seconds'],
                ];
                
                for(var i in pairs) {
                	var value = pairs[i][0];
                	var name = pairs[i][1];
                	
                	if(dt > value) break;
            	}
            	
            	return d3.format('.1f')(dt/value) + ' ' + name;
            }
            
            function values(o){ res = []; for(var x in o) res.push(o[x]); return res; }
            
            d3.json('../local_stats', function(local_stats) {
                d3.select('#peers_in').text(local_stats.peers.incoming);
                d3.select('#peers_out').text(local_stats.peers.outgoing);
                
                var local = d3.sum(values(local_stats.miner_hash_rates));
                var local_dead = d3.sum(values(local_stats.miner_dead_hash_rates));
                d3.select('#local_rate').text(d3.format('.3s')(local) + 'H/s');
                d3.select('#local_doa').text(d3.format('.2p')(local_dead/local));
                
                d3.select('#shares_total').text(local_stats.shares.total);
                d3.select('#shares_orphan').text(local_stats.shares.orphan);
                d3.select('#shares_dead').text(local_stats.shares.dead);
                
                d3.select('#efficiency').text(local_stats.efficiency != null ? d3.format('.4p')(local_stats.efficiency) : '???')
                d3.select('#uptime').text(format_dt(local_stats.uptime));
                d3.select('#block_value').text(local_stats.block_value);
                d3.select('#block_value_payments').text(local_stats.block_value_payments || 0);
                d3.select('#block_value_miner').text(local_stats.block_value_miner || local_stats.block_value);
                
                d3.select('#warnings').selectAll().data(local_stats.warnings).enter().append('p')
                    .text(function(w){ return 'Warning: ' + w })
                    .attr('style', 'color:red;border:1px solid red;padding:5px');
                
                // Version Signaling Status
                d3.json('../version_signaling', function(vs) {
                    if (!vs) {
                        d3.select('#version-signaling').style('display', 'none');
                        return;
                    }
                    
                    d3.select('#version-signaling').style('display', 'block');
                    var pct = vs.v36_percentage;
                    var statusText = 'V36: ' + d3.format('.1f')(pct) + '%';
                    
                    // Add status message based on thresholds
                    if (pct >= 100) {
                        statusText += ' ‚úÖ COMPLETE - All shares V36';
                    } else if (pct >= 95) {
                        statusText += ' üü¢ ACTIVE - Dual donation + MWEB enabled';
                    } else if (pct >= 60) {
                        statusText += ' üü° IMMINENT - Approaching 95% threshold';
                    } else if (pct > 0) {
                        statusText += ' üîµ Signaling in progress';
                    }
                    
                    // Version breakdown (desired_version signaling)
                    var versionsText = '';
                    if (vs.versions) {
                        var verStrs = [];
                        for (var ver in vs.versions) {
                            verStrs.push('Signaling v' + ver + ': ' + d3.format('.1f')(vs.versions[ver].percentage) + '%');
                        }
                        versionsText = ' | ' + verStrs.join(', ');
                    }
                    
                    // Share types breakdown (actual share class versions in chain)
                    var shareTypesText = '';
                    if (vs.share_types) {
                        var typeStrs = [];
                        for (var ver in vs.share_types) {
                            var typeData = vs.share_types[ver];
                            typeStrs.push('V' + ver + ': ' + d3.format('.1f')(typeData.percentage) + '%');
                        }
                        shareTypesText = ' | Chain: ' + typeStrs.join(', ');
                    }
                    
                    d3.select('#version-signaling-text').text(statusText + versionsText + shareTypesText);
                    
                    // Progress bar width
                    d3.select('#version-signaling-bar').style('width', Math.min(100, pct) + '%');
                });
                
                var time_to_share = local_stats.attempts_to_share/local;
                d3.select('#time_to_share').text(local > 0 ? format_dt(time_to_share) : 'Infinity years');
                
                d3.json('../global_stats', function(global_stats) {
                    d3.select('#pool_rate').text(d3.format('.3s')(global_stats.pool_hash_rate) + 'H/s');
                    d3.select('#pool_stale').text(d3.format('.2p')(global_stats.pool_stale_prop));
                    d3.select('#difficulty').text(d3.format('.3r')(global_stats.min_difficulty));
                    
                    var time_to_block = local_stats.attempts_to_block/global_stats.pool_hash_rate;
                    d3.select('#time_to_block').text(format_dt(time_to_block));
                    
                    // Calculate expected payout for 24 hours of mining
                    var block_value = local_stats.block_value_miner || local_stats.block_value || 0;
                    var donation = local_stats.donation_proportion || 0;
                    if (local > 0 && global_stats.pool_hash_rate > 0 && time_to_block > 0 && block_value > 0) {
                        var blocks_in_24h = (24 * 3600) / time_to_block;
                        var payout_per_block = (local/global_stats.pool_hash_rate) * block_value * (1 - donation);
                        var expected_24h_payout = payout_per_block * blocks_in_24h;
                        d3.select('#expected_payout_amount').text(d3.format('.3r')(expected_24h_payout));
                    } else {
                        d3.select('#expected_payout_amount').text('0');
                    }
                    
                    // Fetch and display merged mining expected payout
                    d3.json('../merged_stats', function(merged_stats) {
                        if (merged_stats && merged_stats.block_value && merged_stats.symbol) {
                            d3.select('#merged_block_value').text(d3.format('.2f')(merged_stats.block_value));
                            d3.select('#merged_symbol').text(merged_stats.symbol);
                            d3.select('#merged_symbol2').text(merged_stats.symbol);
                            d3.select('#merged_info').style('display', 'block');
                            
                            // Calculate merged expected payout for 24 hours
                            if (local > 0 && global_stats.pool_hash_rate > 0 && time_to_block > 0) {
                                var blocks_in_24h = (24 * 3600) / time_to_block;
                                var merged_payout_per_block = (local/global_stats.pool_hash_rate) * merged_stats.block_value * (1 - donation);
                                var expected_merged_24h = merged_payout_per_block * blocks_in_24h;
                                d3.select('#expected_merged_payout').text(d3.format('.2f')(expected_merged_24h));
                            } else {
                                d3.select('#expected_merged_payout').text('0');
                            }
                        }
                    });
                });
            });
            
            d3.json('../web/version', function(version) {
                d3.selectAll('#version').text(version);
            });
            
            d3.json('../web/currency_info', function(currency_info) {
                d3.selectAll('.symbol').text(currency_info.symbol);
                
                // Use current_merged_payouts which includes derived merged addresses
                d3.json('../current_merged_payouts', function(mergedPays) {
                    var totamount=0.0;
                    var mergedTotal=0.0;
                    var mergedSymbol='';
                    
                    // Calculate totals
                    for (var addr in mergedPays) {
                        totamount += mergedPays[addr].amount || 0;
                        if (mergedPays[addr].merged) {
                            mergedPays[addr].merged.forEach(function(m) {
                                mergedTotal += m.amount || 0;
                                if (!mergedSymbol) mergedSymbol = m.symbol;
                            });
                        }
                    }
                    d3.select('#payout_totamount').text(totamount.toFixed(8));

                    var arr = []; for(var i in mergedPays) arr.push(i); 
                    arr.sort(function(a, b){return (mergedPays[b].amount || 0) - (mergedPays[a].amount || 0)});
                    
                    // Render payouts table with merged chain sub-rows
                    arr.forEach(function(addr) {
                        var entry = mergedPays[addr];
                        
                        // Main row for parent chain
                        var mainRow = d3.select('#payouts').append('tr');
                        mainRow.append('td').append('a')
                            .text(addr)
                            .attr('href', currency_info.address_explorer_url_prefix + addr);
                        mainRow.append('td').text((entry.amount || 0).toFixed(8));
                        
                        // Sub-rows for merged chain addresses
                        if (entry.merged && entry.merged.length > 0) {
                            entry.merged.forEach(function(merged) {
                                var subRow = d3.select('#payouts').append('tr')
                                    .style('background', 'rgba(111, 66, 193, 0.15)');
                                
                                var addrCell = subRow.append('td')
                                    .style('padding-left', '20px');
                                addrCell.append('span')
                                    .style('color', '#6f42c1')
                                    .style('font-weight', 'bold')
                                    .text('‚Ü≥ ' + merged.symbol + ': ');
                                addrCell.append('a')
                                    .style('color', '#6f42c1')
                                    .text(merged.address)
                                    .attr('href', getMergedExplorerUrl(merged.symbol, merged.address));
                                
                                subRow.append('td')
                                    .style('color', '#6f42c1')
                                    .text(d3.format('.2f')(merged.amount || 0));
                            });
                        }
                    });
                    
                    var total_tr = d3.select('#payouts').append('tr');
                    total_tr.append('td').append('strong').text('Total');
                    total_tr.append('td').text(totamount.toFixed(8));
                    
                    // Add merged total row if we have merged payouts
                    if (mergedTotal > 0 && mergedSymbol) {
                        var merged_total_tr = d3.select('#payouts').append('tr')
                            .style('background', 'rgba(111, 66, 193, 0.2)');
                        merged_total_tr.append('td').append('strong')
                            .style('color', '#6f42c1')
                            .text('Total Merged (' + mergedSymbol + ')');
                        merged_total_tr.append('td')
                            .style('color', '#6f42c1')
                            .style('font-weight', 'bold')
                            .text(d3.format('.2f')(mergedTotal));
                    }
                });
                
                function getMergedExplorerUrl(symbol, address) {
                    var explorers = {
                        'tDOGE': 'https://blockexplorer.one/dogecoin/testnet/address/',
                        'DOGE': 'https://blockexplorer.one/dogecoin/mainnet/address/',
                    };
                    return (explorers[symbol] || '#') + address;
                }
                
                d3.json('../recent_blocks', function(blocks) {
                    // Limit to 10 most recent blocks
                    var displayBlocks = blocks.slice(0, 10);
                    var tr = d3.select('#blocks').selectAll().data(displayBlocks).enter().append('tr');
                    tr.append('td').text(function(block){return new Date(1000*block.ts).toString()});
                    tr.append('td').text(function(block){return block.number});
                    tr.append('td').append('a').text(function(block){return block.hash}).attr('href', function(block){return currency_info.block_explorer_url_prefix + block.hash});
                    tr.append('td').append('a').text('‚Üí').attr('href', function(block){return 'share.html#' + block.share});
                    tr.append('td')
                        .style('color', function(block){
                            if (!block.luck) return '#888';
                            if (block.luck >= 100) return '#28a745';
                            if (block.luck >= 75) return '#ffc107';
                            return '#dc3545';
                        })
                        .style('font-weight', 'bold')
                        .attr('title', function(block){
                            if (!block.time_to_find) return '';
                            var msg = 'Found in ' + format_dt(block.time_to_find);
                            if (block.expected_time) msg += ' (expected: ' + format_dt(block.expected_time) + ')';
                            if (block.luck_method) msg += ' [' + block.luck_method + ']';
                            return msg;
                        })
                        .text(function(block){
                            if (!block.luck) return '-';
                            return d3.format('.0f')(block.luck) + '%';
                        });
                    tr.append('td')
                        .style('color', function(block){
                            if (block.status === 'confirmed') return '#28a745';
                            if (block.status === 'orphaned') return '#dc3545';
                            return '#ffc107';
                        })
                        .style('font-weight', 'bold')
                        .text(function(block){
                            if (block.status === 'confirmed') return '‚úì Confirmed';
                            if (block.status === 'orphaned') return '‚úó Orphaned';
                            return '‚è≥ Pending';
                        });
                });
                
                // Merged mining blocks
                d3.json('../recent_merged_blocks', function(merged_blocks) {
                    if (!merged_blocks || merged_blocks.length === 0) {
                        d3.select('#merged_blocks_section').style('display', 'none');
                        return;
                    }
                    d3.select('#merged_blocks_section').style('display', 'block');
                    
                    // Limit to 10 most recent merged blocks
                    var displayBlocks = merged_blocks.slice(0, 10);
                    
                    // Block explorer URLs for different merged mining chains
                    // Note: Use block hash (not pow_hash) for explorer links
                    var merged_explorers = {
                        98: {  // Dogecoin (chainid 98)
                            testnet: 'https://blockexplorer.one/dogecoin/testnet/blockHash/',
                            mainnet: 'https://blockexplorer.one/dogecoin/mainnet/blockHash/',
                        },
                        // Add more chain explorers here as needed
                    };
                    
                    var tr = d3.select('#merged_blocks').selectAll().data(displayBlocks).enter().append('tr');
                    tr.append('td').text(function(block){return new Date(1000*block.ts).toString()});
                    tr.append('td')
                        .style('font-weight', 'bold')
                        .style('color', '#6f42c1')
                        .text(function(block){return block.symbol || block.network || 'AUX'});
                    tr.append('td').text(function(block){return block.chainid || '-'});
                    // Display pow_hash (unique per found block) with explorer link
                    tr.append('td').append('a')
                        .text(function(block){
                            // Show pow_hash which is unique per found block
                            var display_hash = block.pow_hash || '-';
                            return display_hash.substring(0, 16) + '...';
                        })
                        .attr('href', function(block){
                            var explorer_config = merged_explorers[block.chainid];
                            if (explorer_config && block.pow_hash) {
                                // Use testnet explorer for now (could detect from network name)
                                var explorer = explorer_config.testnet;
                                return explorer + block.pow_hash;
                            }
                            return '#';
                        })
                        .attr('target', '_blank')
                        .attr('title', function(block){
                            return 'POW Hash: ' + (block.pow_hash || 'N/A') + '\nTemplate Hash: ' + (block.hash || 'N/A');
                        });
                    tr.append('td').text(function(block){return block.miner || '-'});
                    tr.append('td').text(function(block){return block.txs || '-'});
                    tr.append('td')
                        .style('color', function(block){
                            if (block.is_testnet) {
                                // Testnet: show verification status
                                if (block.verified === true) return '#28a745';  // Green for verified
                                if (block.verified === false) return '#dc3545';  // Red for orphaned
                                return '#ffc107';  // Yellow for pending verification
                            }
                            return '#17a2b8';  // Blue for mainnet (submitted)
                        })
                        .style('font-weight', 'bold')
                        .text(function(block){
                            if (block.is_testnet) {
                                // Testnet: show verification status
                                if (block.verified === true) return '‚úì Verified';
                                if (block.verified === false) return '‚úó Orphaned';
                                return '‚è≥ Verifying...';
                            }
                            return '‚Üë Submitted';  // Mainnet: just show submitted
                        });
                });
            });
            
            d3.json('../web/best_share_hash', function(c) {
                d3.select('#best_share').append('a').attr('href', 'share.html#' + c).text(c.substr(-8));
            });
            
            function fill(url, id) {
                d3.json(url, function(d) {
                    d.sort()
                    d3.select(id).selectAll().data(d).enter().append('span').text(' ').append('a').attr('href', function(c){return 'share.html#' + c}).text(function(c){return c.substr(-8)});
                });
            }
            fill('../web/verified_heads', '#verified_heads');
            fill('../web/heads', '#heads');
            fill('../web/verified_tails', '#verified_tails');
            fill('../web/tails', '#tails');
            fill('../web/my_share_hashes50', '#my_share_hashes');
        </script>
    </head>
    <body>
        <h1>P2Pool <span class="symbol"></span></h1>
        <p><a href="dashboard.html"><strong>üÜï New Dashboard</strong></a> | <a href="graphs.html">Graphs</a> | <a href="stratum.html">Stratum Stats</a></p>
        <p>Version: <span id="version"></span></p>
        <p>Pool rate: <span id="pool_rate"></span> (<span id="pool_stale"></span> DOA+orphan) Share difficulty: <span id="difficulty"></span></p>
        <p>Node uptime: <span id="uptime"></span> Peers: <span id="peers_out"></span> out, <span id="peers_in"></span> in</p>
        <p>Local rate: <span id="local_rate"></span> (<span id="local_doa"></span> DOA) Expected time to share: <span id="time_to_share"></span></p>
        <p>Shares: <span id="shares_total"></span> total (<span id="shares_orphan"></span> orphaned, <span id="shares_dead"></span> dead) Efficiency: <span id="efficiency"></span></p>
        <p>Payout if a block were found NOW: <span id="payout_totamount"></span> <span class="symbol"></span> to <a id="payout_addrs"></a>. Expected payout after mining for 24 hours: <span id="expected_payout_amount"></span> <span class="symbol"></span></p>
        <p id="merged_info" style="display:none; color:#6f42c1; font-weight:bold;">Merged mining block value: <span id="merged_block_value"></span> <span id="merged_symbol"></span>. Expected merged payout (24h): <span id="expected_merged_payout"></span> <span id="merged_symbol2"></span></p>
        <p>Current block value: <span id="block_value"></span> <span class="symbol"></span>. Expected time to block: <span id="time_to_block"></span></p>
        <div id="warnings"></div>
        
        <!-- Version Signaling Status -->
        <div id="version-signaling" style="display:none; background:#f0e6ff; border:2px solid #6f42c1; border-radius:5px; padding:10px; margin:10px 0;">
            <div style="display:flex; align-items:center; gap:10px;">
                <span style="font-size:1.2em;">üîÑ</span>
                <strong>V36 Upgrade Status:</strong>
                <span id="version-signaling-text">Loading...</span>
            </div>
            <div style="background:#ddd; height:12px; border-radius:6px; margin-top:8px; overflow:hidden;">
                <div id="version-signaling-bar" style="height:100%; background:linear-gradient(90deg, #6f42c1, #28a745); width:0%; transition:width 0.5s;"></div>
            </div>
        </div>
        
        <h2>Share explorer</h2>
        <p>Best share: <span id="best_share"></span></p>
        <p>Verified heads: <span id="verified_heads"></span></p>
        <p>Heads: <span id="heads"></span></p>
        <p>Verified tails: <span id="verified_tails"></span></p>
        <p>Tails: <span id="tails"></span></p>
        <p>My shares: <span id="my_share_hashes"></span></p>
        
        <h2>Blocks found recently:</h2>
        <p>Note that blocks may have been orphaned from the P2Pool chain and so not be here.</p>
        <table border="1" id="blocks">
            <tr><th>time</th><th>number</th><th>hash/explorer link</th><th>share</th><th>luck</th><th>status</th></tr>
        </table>
        
        <div id="merged_blocks_section" style="display:none;">
            <h2>Merged Mining Blocks found recently:</h2>
            <p>Blocks found on auxiliary chains via merged mining.</p>
            <table border="1" id="merged_blocks">
                <tr><th>time</th><th>network</th><th>chain id</th><th>block hash/explorer</th><th>miner</th><th>txs</th><th>status</th></tr>
            </table>
        </div>
        
        <h2>Payouts if a block were found NOW:</h2>
        <table border="1" id="payouts">
            <tr><th>address</th><th>amount in <span class="symbol"></span></th></tr>
        </table>
    </body>
</html>
